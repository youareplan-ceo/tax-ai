# YouArePlan EasyTax v8 - ë³´ì•ˆ ìŠ¤ìº” ì›Œí¬í”Œë¡œìš°
# ì •ê¸°ì ì¸ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ ë° ì˜ì¡´ì„± ì—…ë°ì´íŠ¸
name: Security Scan

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œ (UTC) ì‹¤í–‰
    - cron: '0 2 * * *'
  push:
    branches: [ main ]
    paths:
      - 'requirements.txt'
      - '.github/workflows/security-scan.yml'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰

jobs:
  # ì˜ì¡´ì„± ë³´ì•ˆ ìŠ¤ìº”
  dependency-scan:
    runs-on: ubuntu-latest
    name: ì˜ì¡´ì„± ë³´ì•ˆ ìŠ¤ìº”
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
        
    - name: ë³´ì•ˆ ë„êµ¬ ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit semgrep pip-audit
        pip install -r requirements.txt
        
    - name: Safety ì·¨ì•½ì  ìŠ¤ìº”
      run: |
        echo "ğŸ” Safetyë¡œ ì•Œë ¤ì§„ ì·¨ì•½ì  ìŠ¤ìº” ì¤‘..."
        safety check --json --output safety-report.json || true
        echo "âœ… Safety ìŠ¤ìº” ì™„ë£Œ"
        
    - name: Pip-audit ì˜ì¡´ì„± ìŠ¤ìº”
      run: |
        echo "ğŸ” pip-auditë¡œ ì˜ì¡´ì„± ì·¨ì•½ì  ìŠ¤ìº” ì¤‘..."
        pip-audit --format=json --output=pip-audit-report.json || true
        echo "âœ… Pip-audit ìŠ¤ìº” ì™„ë£Œ"
        
    - name: Bandit ë³´ì•ˆ ìŠ¤ìº”
      run: |
        echo "ğŸ” Banditìœ¼ë¡œ ì½”ë“œ ë³´ì•ˆ ìŠ¤ìº” ì¤‘..."
        bandit -r . -f json -o bandit-report.json -x .venv,tests || true
        echo "âœ… Bandit ìŠ¤ìº” ì™„ë£Œ"
        
    - name: ì»¤ìŠ¤í…€ ë³´ì•ˆ ê°ì‚¬
      run: |
        echo "ğŸ” YouArePlan ì»¤ìŠ¤í…€ ë³´ì•ˆ ê°ì‚¬ ì‹¤í–‰ ì¤‘..."
        python security_audit.py --format json --output security-audit-report.json
        echo "âœ… ì»¤ìŠ¤í…€ ë³´ì•ˆ ê°ì‚¬ ì™„ë£Œ"
        
    - name: ë³´ì•ˆ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          *-report.json
          reports/
        retention-days: 90
        
    - name: ë³´ì•ˆ ì•Œë¦¼ ìƒì„±
      run: |
        echo "ğŸ“Š ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ìš”ì•½ ìƒì„± ì¤‘..."
        python -c "
        import json
        import os
        
        # ë³´ì•ˆ ë¦¬í¬íŠ¸ íŒŒì¼ë“¤ í™•ì¸
        reports = {}
        for file in ['safety-report.json', 'pip-audit-report.json', 'bandit-report.json', 'security-audit-report.json']:
            if os.path.exists(file):
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        reports[file] = json.load(f)
                except:
                    reports[file] = {'error': 'Failed to parse'}
        
        # ìš”ì•½ ìƒì„±
        total_issues = 0
        high_severity = 0
        
        print('ğŸ›¡ï¸ YouArePlan EasyTax v8 ë³´ì•ˆ ìŠ¤ìº” ìš”ì•½')
        print('=' * 50)
        
        for report_name, data in reports.items():
            print(f'ğŸ“‹ {report_name}:')
            if 'error' in data:
                print(f'  âŒ íŒŒì‹± ì˜¤ë¥˜')
            elif report_name == 'security-audit-report.json':
                if 'summary' in data:
                    issues = data['summary'].get('total_issues', 0)
                    high = data['summary'].get('severity_breakdown', {}).get('HIGH', 0)
                    total_issues += issues
                    high_severity += high
                    print(f'  ğŸ“Š ì´ ì´ìŠˆ: {issues}ê°œ')
                    print(f'  ğŸš¨ HIGH ìœ„í—˜: {high}ê°œ')
            print()
        
        print(f'ğŸ¯ ì „ì²´ ìš”ì•½:')
        print(f'  ì´ ë³´ì•ˆ ì´ìŠˆ: {total_issues}ê°œ')
        print(f'  ê³ ìœ„í—˜ ì´ìŠˆ: {high_severity}ê°œ')
        
        # GitHub í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
        with open(os.environ['GITHUB_ENV'], 'a') as f:
            f.write(f'TOTAL_SECURITY_ISSUES={total_issues}\\n')
            f.write(f'HIGH_SEVERITY_ISSUES={high_severity}\\n')
        "

  # ì½”ë“œ í’ˆì§ˆ ìŠ¤ìº”
  code-quality-scan:
    runs-on: ubuntu-latest
    name: ì½”ë“œ í’ˆì§ˆ ìŠ¤ìº”
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Semgrep ë³´ì•ˆ ìŠ¤ìº”
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/python
          p/django
        generateSarif: "1"
        
    - name: SARIF ê²°ê³¼ ì—…ë¡œë“œ
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: semgrep.sarif
      if: always()

  # Secrets ìŠ¤ìº”
  secrets-scan:
    runs-on: ubuntu-latest
    name: ì‹œí¬ë¦¿ í‚¤ ìŠ¤ìº”
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
        
    - name: TruffleHog ì‹œí¬ë¦¿ ìŠ¤ìº”
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

  # ë³´ì•ˆ ì•Œë¦¼ ë° ì´ìŠˆ ìƒì„±
  security-notification:
    needs: [dependency-scan, code-quality-scan, secrets-scan]
    runs-on: ubuntu-latest
    name: ë³´ì•ˆ ì•Œë¦¼
    if: always()
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ë³´ì•ˆ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v3
      with:
        name: security-reports
        path: ./security-reports/
      continue-on-error: true
      
    - name: ê³ ìœ„í—˜ ì´ìŠˆ í™•ì¸
      id: check-issues
      run: |
        # í™˜ê²½ ë³€ìˆ˜ì—ì„œ ë³´ì•ˆ ì´ìŠˆ ìˆ˜ í™•ì¸
        TOTAL_ISSUES=${TOTAL_SECURITY_ISSUES:-0}
        HIGH_ISSUES=${HIGH_SEVERITY_ISSUES:-0}
        
        echo "total_issues=${TOTAL_ISSUES}" >> $GITHUB_OUTPUT
        echo "high_issues=${HIGH_ISSUES}" >> $GITHUB_OUTPUT
        
        if [ "${HIGH_ISSUES}" -gt 0 ]; then
          echo "create_issue=true" >> $GITHUB_OUTPUT
          echo "ğŸš¨ ê³ ìœ„í—˜ ë³´ì•ˆ ì´ìŠˆ ê°ì§€: ${HIGH_ISSUES}ê°œ"
        else
          echo "create_issue=false" >> $GITHUB_OUTPUT
          echo "âœ… ê³ ìœ„í—˜ ë³´ì•ˆ ì´ìŠˆ ì—†ìŒ"
        fi
        
    - name: ë³´ì•ˆ ì´ìŠˆ ìë™ ìƒì„±
      if: steps.check-issues.outputs.create_issue == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'security,high-priority',
            state: 'open'
          });
          
          // ì¤‘ë³µ ì´ìŠˆ ë°©ì§€
          const existingIssue = issues.find(issue => 
            issue.title.includes('ğŸš¨ ê³ ìœ„í—˜ ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬')
          );
          
          if (!existingIssue) {
            const issueBody = `
          ## ğŸš¨ ê³ ìœ„í—˜ ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬
          
          **ìŠ¤ìº” ì¼ì‹œ**: ${new Date().toISOString()}
          **ì»¤ë°‹**: ${context.sha}
          **ê³ ìœ„í—˜ ì´ìŠˆ**: ${process.env.HIGH_SEVERITY_ISSUES}ê°œ
          **ì´ ì´ìŠˆ**: ${process.env.TOTAL_SECURITY_ISSUES}ê°œ
          
          ### ğŸ“‹ ì¦‰ì‹œ ì¡°ì¹˜ì‚¬í•­
          
          1. [ ] ë³´ì•ˆ ë¦¬í¬íŠ¸ ê²€í† 
          2. [ ] ê³ ìœ„í—˜ ì·¨ì•½ì  íŒ¨ì¹˜ ì ìš©
          3. [ ] ì˜ì¡´ì„± ì—…ë°ì´íŠ¸
          4. [ ] ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ì¬ì‹¤í–‰
          
          ### ğŸ“Š ìƒì„¸ ë¦¬í¬íŠ¸
          
          Actions íƒ­ì—ì„œ [Security Scan ì›Œí¬í”Œë¡œìš°](${context.payload.repository.html_url}/actions) ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.
          
          **ìë™ ìƒì„± ì´ìŠˆ** - í•´ê²° í›„ ìˆ˜ë™ìœ¼ë¡œ ë‹«ì•„ì£¼ì„¸ìš”.
          `;
          
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ ê³ ìœ„í—˜ ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬ - ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”',
              body: issueBody,
              labels: ['security', 'high-priority', 'bug'],
              assignees: [context.actor]
            });
            
            console.log('âœ… ë³´ì•ˆ ì´ìŠˆ ìë™ ìƒì„± ì™„ë£Œ');
          } else {
            console.log('â­ï¸ ê¸°ì¡´ ë³´ì•ˆ ì´ìŠˆê°€ ì—´ë ¤ìˆì–´ ìƒˆ ì´ìŠˆ ìƒì„± ìƒëµ');
          }
        
    - name: Slack ë³´ì•ˆ ì•Œë¦¼
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        channel: '#security-alerts'
        custom_payload: |
          {
            "text": "ğŸ›¡ï¸ YouArePlan EasyTax v8 ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ",
            "attachments": [
              {
                "color": "${{ steps.check-issues.outputs.high_issues > 0 && 'danger' || 'good' }}",
                "fields": [
                  {
                    "title": "ì´ ë³´ì•ˆ ì´ìŠˆ",
                    "value": "${{ steps.check-issues.outputs.total_issues }}ê°œ",
                    "short": true
                  },
                  {
                    "title": "ê³ ìœ„í—˜ ì´ìŠˆ",
                    "value": "${{ steps.check-issues.outputs.high_issues }}ê°œ",
                    "short": true
                  },
                  {
                    "title": "ìŠ¤ìº” ì‹œê°„",
                    "value": "${{ github.event.head_commit.timestamp }}",
                    "short": true
                  },
                  {
                    "title": "ì»¤ë°‹",
                    "value": "<${{ github.event.head_commit.url }}|${{ github.sha }}>",
                    "short": true
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      if: always()

# ì›Œí¬í”Œë¡œìš° ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  security-events: write
  issues: write